<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【Android BLE】蓝牙「防丢器」的相关知识点（二）：连接设备并检测连接状态 | 阿富的笔记本</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Android 安卓 miniprogram 小程序 Html Css Javascript">
    
    <link rel="preload" href="/assets/css/0.styles.460a1adf.css" as="style"><link rel="preload" href="/assets/js/app.67f31782.js" as="script"><link rel="preload" href="/assets/js/2.4b79b7dc.js" as="script"><link rel="preload" href="/assets/js/14.74441acb.js" as="script"><link rel="prefetch" href="/assets/js/10.c6c178b6.js"><link rel="prefetch" href="/assets/js/11.29d1fe38.js"><link rel="prefetch" href="/assets/js/12.1096197c.js"><link rel="prefetch" href="/assets/js/13.7dcb0591.js"><link rel="prefetch" href="/assets/js/15.e253b149.js"><link rel="prefetch" href="/assets/js/16.cb366f0a.js"><link rel="prefetch" href="/assets/js/17.3fce5bda.js"><link rel="prefetch" href="/assets/js/18.9baa81ec.js"><link rel="prefetch" href="/assets/js/19.7e699f3c.js"><link rel="prefetch" href="/assets/js/20.69b9ebc0.js"><link rel="prefetch" href="/assets/js/21.fea2c0c8.js"><link rel="prefetch" href="/assets/js/22.786e363d.js"><link rel="prefetch" href="/assets/js/3.4487d2a3.js"><link rel="prefetch" href="/assets/js/4.ef6e4a50.js"><link rel="prefetch" href="/assets/js/5.eae85225.js"><link rel="prefetch" href="/assets/js/6.f67fb97d.js"><link rel="prefetch" href="/assets/js/7.8f502614.js"><link rel="prefetch" href="/assets/js/8.b840a4aa.js"><link rel="prefetch" href="/assets/js/9.2998da34.js">
    <link rel="stylesheet" href="/assets/css/0.styles.460a1adf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/bigHero.png" alt="阿富的笔记本" class="logo"> <span class="site-name can-hide">阿富的笔记本</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Android</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/android/note.html" class="sidebar-link">Android开发(持续更新)</a></li><li><a href="/android/player-ijkplayer.html" class="sidebar-link">视频播放（基于ijkplayer）</a></li><li><a href="/android/intent-share-filter.html" class="sidebar-link">Intent分享，按需要过滤</a></li><li><a href="/android/intent-open-youtube.html" class="sidebar-link">Intent打开Youtube并带入搜索关键字</a></li><li><a href="/android/ble-tether-1.html" class="sidebar-link">【BLE】蓝牙「防丢器」（一）</a></li><li><a href="/android/ble-tether-2.html" aria-current="page" class="active sidebar-link">【BLE】蓝牙「防丢器」（二）</a></li><li><a href="/android/ble-tether-3.html" class="sidebar-link">【BLE】蓝牙「防丢器」（三）</a></li><li><a href="/android/trivia-smb-browse.html" class="sidebar-link">【冷知识】SMB浏览</a></li><li><a href="/android/trivia-smb-http.html" class="sidebar-link">【冷知识】SMB转Http协议</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>微信小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/miniprogram/note.html" class="sidebar-link">小程序开发(持续更新)</a></li><li><a href="/miniprogram/watermark.html" class="sidebar-link">页面添加水印，防止截图</a></li><li><a href="/miniprogram/plugins-handwriting.html" class="sidebar-link">小程序插件-手写签名</a></li><li><a href="/miniprogram/plugins-calendar.html" class="sidebar-link">小程序插件-日历</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Html相关</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="【android-ble】蓝牙「防丢器」的相关知识点-二-连接设备并检测连接状态"><a href="#【android-ble】蓝牙「防丢器」的相关知识点-二-连接设备并检测连接状态" class="header-anchor">#</a> 【Android BLE】蓝牙「防丢器」的相关知识点（二）：连接设备并检测连接状态</h1> <ul><li><a href="./ble-tether-1">蓝牙「防丢器」的相关知识点（一）：扫描并识别设备</a></li> <li><a href="./ble-tether-2">蓝牙「防丢器」的相关知识点（二）：连接设备并检测连接状态</a></li> <li><a href="./ble-tether-3">蓝牙「防丢器」的相关知识点（三）：手机与设备之间指令传输</a></li></ul> <h2 id="_1-初始化蓝牙连接服务类"><a href="#_1-初始化蓝牙连接服务类" class="header-anchor">#</a> 1.初始化蓝牙连接服务类</h2> <p>在扫描并识别到自家设备后，接下来就是连接设备，并绑定该设备到手机了。在连接设备之前，我们需要初始化蓝牙连接服务，这个初始化放在应用的Application中进行，整个应用与该服务密切相关。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BluetoothLeService</span> mBluetoothLeService<span class="token punctuation">;</span> <span class="token comment">// 蓝牙连接服务</span>
<span class="token keyword">public</span> <span class="token class-name">ServiceConnection</span> mServiceConnection<span class="token punctuation">;</span> <span class="token comment">// 蓝牙连接服务</span>

<span class="token comment">/**
 * 初始化BLE相关
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initBle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 初始化并绑定服务</span>
	mServiceConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ComponentName</span> componentName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">IBinder</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;--onServiceConnected--&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			mBluetoothLeService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BluetoothLeService<span class="token punctuation">.</span>LocalBinder</span><span class="token punctuation">)</span> service<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBluetoothLeService<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to initialize Bluetooth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ComponentName</span> componentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mBluetoothLeService <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token class-name">Intent</span> gattServiceIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">BluetoothLeService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">bindService</span><span class="token punctuation">(</span>gattServiceIntent<span class="token punctuation">,</span> mServiceConnection<span class="token punctuation">,</span> BIND_AUTO_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>初始化过程：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BluetoothManager</span> mBluetoothManager<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">BluetoothAdapter</span> mBluetoothAdapter<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// For API level 18 and above, get a reference to BluetoothAdapter through</span>
	<span class="token comment">// BluetoothManager.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		mBluetoothManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>BLUETOOTH_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to initialize BluetoothManager.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	mBluetoothAdapter <span class="token operator">=</span> mBluetoothManager<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to obtain a BluetoothAdapter.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>*<em>以上过程在Application的onCreate中进行，以下我再写点与业务逻辑相关的，可不看！该逻辑主要是用来定时检测已经绑定过的设备是否都已经连接，实际场景就是：用户可能在钱包、背包、遥控器上等放置了防丢器，如果超距后会断开连接，但是重新回到连接范围后，手机要发起重连请求，这依赖于此定时检测服务。</em></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 以下与应用业务逻辑高度关联，可不看</span>
<span class="token class-name">TimerTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BluetoothManager</span> btManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>BLUETOOTH_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">BluetoothAdapter</span> mBluetoothAdapter <span class="token operator">=</span> btManager<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;^^^蓝牙没打开^^^&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothLeService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 如果之前有连接信息，需要清除(不清除的后果就是蓝牙重新打开，会检测到之前连接过，但是其实此时并未重新连接)</span>
				mBluetoothLeService<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothLeService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Beagle</span><span class="token punctuation">&gt;</span></span> mBeagles <span class="token operator">=</span> <span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothDevice</span><span class="token punctuation">&gt;</span></span> connectDevices <span class="token operator">=</span> mBluetoothLeService<span class="token punctuation">.</span><span class="token function">getConnectedDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Beagle</span> beagle <span class="token operator">:</span> mBeagles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;检查：&quot;</span> <span class="token operator">+</span> beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">boolean</span> isConnected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothDevice</span> bd <span class="token operator">:</span> connectDevices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;定时检测，设备已经处于连接状态：&quot;</span> <span class="token operator">+</span> beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						isConnected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 未连接时，自动重连</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">boolean</span> flag <span class="token operator">=</span> mBluetoothLeService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;连接成功：&quot;</span> <span class="token operator">+</span> beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;连接失败：&quot;</span> <span class="token operator">+</span> beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

mTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mTimer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="_2-连接ble设备"><a href="#_2-连接ble设备" class="header-anchor">#</a> 2.连接BLE设备</h2> <p>其实连接设备的步骤非常简单，代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mDeviceAddress <span class="token operator">=</span> mAdapterList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mBluetoothLeService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mDeviceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对应的<code>BluetoothLeService</code>中方法如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 连接蓝牙设备
 *
 * @param mac mac
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized or unspecified address.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothDevice</span><span class="token punctuation">&gt;</span></span> connectDevices <span class="token operator">=</span> <span class="token function">getConnectedDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothDevice</span> bd <span class="token operator">:</span> connectDevices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mac<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;该设备已经连接啦：&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 使用之前连接过的</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;使用之前连接过的：&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token class-name">BluetoothDevice</span> device <span class="token operator">=</span> mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">getRemoteDevice</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Device not found.  Unable to connect.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	device<span class="token punctuation">.</span><span class="token function">connectGatt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mGattCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;创建一个新连接，MAC=&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>*<em>这里的getApp()就是获取应用的静态Application，BluetoothLeService类内容较多，最后附上，下面拆分简单说下。</em></p> <h2 id="_3-处理连接后的回调事件"><a href="#_3-处理连接后的回调事件" class="header-anchor">#</a> 3.处理连接后的回调事件</h2> <p>在上面的连接设备方法中，有一个很关键的参数<code>mGattCallback</code>，这个是用来接收蓝牙连接的各类回调事件的，我们主要的业务逻辑都会在此处理：连接成功后的服务通道获取、认证、断开连接处理、指令发送与接收回调、信号强度变化等等。
其对应的代码如下，其实根据BluetoothGattCallback需要重写的方法名称，也能大概知道其作用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCallback</span> mGattCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicChanged</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCharacteristic</span>
			characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">dealWithData</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicRead</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">dealWithData</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;读取通道信息失败：&quot;</span> <span class="token operator">+</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionStateChange</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothGatt连接上,MAC:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			gatt<span class="token punctuation">.</span><span class="token function">discoverServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			mBluetoothGatts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_DISCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">dealDeviceDisconnected</span><span class="token punctuation">(</span>gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothGatt断开,MAC:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">String</span> uuidStr <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onCharacteristicWrite--&gt;\nmac:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\nuuid:&quot;</span> <span class="token operator">+</span> uuidStr <span class="token operator">+</span>
				<span class="token string">&quot;\n发送的值:&quot;</span> <span class="token operator">+</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">byteArrayToHexString</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\nstatus:&quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 设备信息设置</span>

			<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> action <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_MODE_THETHER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_MODE_THETHER<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_MODE_FIND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_MODE_FIND<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_FIND_LIGHT_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_FIND_LIGHT_ON<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_FIND_LIGHT_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_FIND_LIGHT_OFF<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_TETHER_BEEP_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_TETHER_BEEP_ON<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_TETHER_BEEP_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_TETHER_BEEP_OFF<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_IMMEDIATE_C_ALERT<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 立即警报设置</span>

			<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_IMMEDIATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C_LOGIN<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// 通知绑定页面</span>
			<span class="token class-name">BindEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">BindEvent</span><span class="token punctuation">.</span>ACTION_BIND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C_UNBIND<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 解绑命令</span>
			<span class="token class-name">QueryBuilder</span> qb <span class="token operator">=</span> <span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name">BeagleDao<span class="token punctuation">.</span>Properties<span class="token punctuation">.</span>Mac</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Beagle</span><span class="token punctuation">&gt;</span></span> mBeagles <span class="token operator">=</span> qb<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">Beagle</span> beagle<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mBeagles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				beagle <span class="token operator">=</span> mBeagles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getUpdateStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Beagle</span><span class="token punctuation">.</span>UPDATE_PROCESSING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;解绑--升级…………&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				mBluetoothGatts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;解绑！！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteByKey</span><span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServicesDiscovered</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onServicesDiscovered received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">dealServicesDiscoverd</span><span class="token punctuation">(</span>gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onServicesDiscovered received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReadRemoteRssi</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> rssi<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_RSSI<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setRssi</span><span class="token punctuation">(</span>rssi<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onReadRemoteRssi received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><p>通常在建立连接后，会进入onServicesDiscovered方法，这个时候可已根据需要去发起一些通道的订阅（可遍历所有通道信息，根据通道的可读、通知属性来订阅）。我这里，手机需要向设备发起认证信息（这个需要固件配合，认证后，其他手机就扫描不到该设备了），认证的指令自定义约定，此处略。从最后附录的全部代码可以看到认证指令发送失败是立即通知程序页面认证失败的，但是成功发送认证指令，并没有立即通知，这里要注意，真正的指令是否成功写入设备，是要通过onCharacteristicWrite来判断的：</p> <ul><li>onCharacteristicChanged：接收到通道指令（前提是已经订阅），如设备的点击、双击、长按事件；</li> <li>onCharacteristicRead：手机主动发起的read后，设备回传过来的数据，如读取设备电量、固件版本等；</li> <li>onConnectionStateChange：设备与手机的连接状态变化：连接成功、断开连接；</li> <li>onCharacteristicWrite：手机向设备写入指令的结果，该方法中可获取被写入通道的ID，内容，状态；</li> <li>onServicesDiscovered：刚建立连接时，设备拥有的服务被发现；</li> <li>onReadRemoteRssi：设备信号强度变化。</li></ul> <p>要处理手机与设备之间的业务，BluetoothGattCallback是重点，再各个回调方法中，结合自己的业务逻辑，基本可完成应用的基础功能：绑定（成功后是要写入手机本地数据库的，与蓝牙无关就不贴了）、断开报警、信号弱时提醒距离远、接收设备指令来完成对应动作……</p> <h2 id="_4-附录"><a href="#_4-附录" class="header-anchor">#</a> 4. 附录：</h2> <p>上面的代码中有一些方法代码缺失，下面是<code>BluetoothLeService.java</code>完整代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>services</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">Notification</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">PendingIntent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothDevice</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothGatt</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothGattCharacteristic</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothGattService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>bluetooth<span class="token punctuation">.</span></span><span class="token class-name">BluetoothProfile</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Intent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">AudioManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">MediaPlayer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">RingtoneManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Uri</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Binder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">IBinder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">NotificationCompat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>telephony<span class="token punctuation">.</span></span><span class="token class-name">TelephonyManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">TextUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>afap<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ByteUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span></span><span class="token class-name">MyApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span></span><span class="token class-name">R</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">BatteryEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">BindEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">FirmwareEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">StatusEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>greendao<span class="token punctuation">.</span></span><span class="token class-name">Beagle</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>greendao<span class="token punctuation">.</span></span><span class="token class-name">BeagleDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span></span><span class="token class-name">GattUpdateReceiver</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">BluetoothUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>powerstick<span class="token punctuation">.</span>beaglepro<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Utils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>bugly<span class="token punctuation">.</span>crashreport<span class="token punctuation">.</span></span><span class="token class-name">BuglyLog</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>eventbus<span class="token punctuation">.</span></span><span class="token class-name">EventBus</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">de<span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryBuilder</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BluetoothLeService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">&quot;BluetoothLeService&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IBinder</span> mBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">BluetoothManager</span> mBluetoothManager<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">BluetoothAdapter</span> mBluetoothAdapter<span class="token punctuation">;</span>
	<span class="token comment">// 记录MAC对应的BluetoothGatt，可通过MAC来获取各个设备的BluetoothGatt</span>
	<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">&gt;</span></span> mBluetoothGatts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCallback</span> mGattCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicChanged</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCharacteristic</span>
				characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">dealWithData</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicRead</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">dealWithData</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;读取通道信息失败：&quot;</span> <span class="token operator">+</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionStateChange</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothGatt连接上,MAC:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				gatt<span class="token punctuation">.</span><span class="token function">discoverServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				mBluetoothGatts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_DISCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">dealDeviceDisconnected</span><span class="token punctuation">(</span>gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothGatt断开,MAC:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> characteristic<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">String</span> uuidStr <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onCharacteristicWrite--&gt;\nmac:&quot;</span> <span class="token operator">+</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\nuuid:&quot;</span> <span class="token operator">+</span> uuidStr <span class="token operator">+</span>
					<span class="token string">&quot;\n发送的值:&quot;</span> <span class="token operator">+</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">byteArrayToHexString</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\nstatus:&quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 设备信息设置</span>

				<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">String</span> action <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_MODE_THETHER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_MODE_THETHER<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_MODE_FIND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_MODE_FIND<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_FIND_LIGHT_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_FIND_LIGHT_ON<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_FIND_LIGHT_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_FIND_LIGHT_OFF<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_TETHER_BEEP_ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_TETHER_BEEP_ON<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>VALUE_TETHER_BEEP_OFF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					action <span class="token operator">=</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_TETHER_BEEP_OFF<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_IMMEDIATE_C_ALERT<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 立即警报设置</span>

				<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_IMMEDIATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C_LOGIN<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				<span class="token comment">// 通知绑定页面</span>
				<span class="token class-name">BindEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">BindEvent</span><span class="token punctuation">.</span>ACTION_BIND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuidStr<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C_UNBIND<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 解绑命令</span>
				<span class="token class-name">QueryBuilder</span> qb <span class="token operator">=</span> <span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name">BeagleDao<span class="token punctuation">.</span>Properties<span class="token punctuation">.</span>Mac</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Beagle</span><span class="token punctuation">&gt;</span></span> mBeagles <span class="token operator">=</span> qb<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token class-name">Beagle</span> beagle<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mBeagles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					beagle <span class="token operator">=</span> mBeagles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 升级完毕后的解绑，不做删除</span>
<span class="token comment">//                if (beagle.getUpdateStatus() == Beagle.UPDATE_COMPLETED) {</span>
<span class="token comment">//                    BuglyLog.d(TAG, &quot;解绑--升级完毕&quot;);</span>
<span class="token comment">//                    beagle.setUpdateStatus(Beagle.UPDATE_NONE);</span>
<span class="token comment">//                    MyApplication.getInstance().getDaoSession().getBeagleDao().update(beagle);</span>
<span class="token comment">//                } else</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getUpdateStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Beagle</span><span class="token punctuation">.</span>UPDATE_PROCESSING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;解绑--升级…………&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					mBluetoothGatts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;解绑！！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteByKey</span><span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_UNBIND<span class="token punctuation">)</span><span class="token punctuation">;</span>
					e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServicesDiscovered</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onServicesDiscovered received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">dealServicesDiscoverd</span><span class="token punctuation">(</span>gatt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onServicesDiscovered received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReadRemoteRssi</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> rssi<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

				<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_RSSI<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setRssi</span><span class="token punctuation">(</span>rssi<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onReadRemoteRssi received: &quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// For API level 18 and above, get a reference to BluetoothAdapter through</span>
		<span class="token comment">// BluetoothManager.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mBluetoothManager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>BLUETOOTH_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to initialize BluetoothManager.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		mBluetoothAdapter <span class="token operator">=</span> mBluetoothManager<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Unable to obtain a BluetoothAdapter.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">BluetoothGatt</span> <span class="token function">getGatt</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt <span class="token operator">:</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>gatt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				gatt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				gatt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized or unspecified address.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* 连接蓝牙设备
		*
		* @param mac mac
		*/</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized or unspecified address.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothDevice</span><span class="token punctuation">&gt;</span></span> connectDevices <span class="token operator">=</span> <span class="token function">getConnectedDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothDevice</span> bd <span class="token operator">:</span> connectDevices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mac<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;该设备已经连接啦：&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 使用之前连接过的</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;使用之前连接过的：&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">final</span> <span class="token class-name">BluetoothDevice</span> device <span class="token operator">=</span> mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">getRemoteDevice</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Device not found.  Unable to connect.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		device<span class="token punctuation">.</span><span class="token function">connectGatt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mGattCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;创建一个新连接，MAC=&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* Disconnects an existing connection or cancel a pending connection. The disconnection result
		* is reported asynchronously through the
		* {@code BluetoothGattCallback#onConnectionStateChange(android.bluetooth.BluetoothGatt, int, int)}
		* callback.
		*/</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">BluetoothGatt</span> gatt <span class="token operator">=</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		gatt<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		gatt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* Retrieves a list of supported GATT services on the connected device. This should be
		* invoked only after {@code BluetoothGatt#discoverServices()} completes successfully.
		*
		* @return A {@code List} of supported services.
		*/</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothGattService</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedGattServices</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* 读取目标通道数据
		*
		* @param mac            目标设备MAC
		* @param characteristic 目标通道
		*/</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCharacteristic</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* 向目标通道写入数据
		*
		* @param mac            目标设备MAC
		* @param characteristic 目标通道
		*/</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">writeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeCharacteristic</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
		* 设置监听通道通知
		*
		* @param mac            目标设备MAC
		* @param characteristic 目标通道
		* @param enabled        是否接收通知
		*/</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothAdapter未初始化&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothDevice</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConnectedDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> mBluetoothManager<span class="token punctuation">.</span><span class="token function">getConnectedDevices</span><span class="token punctuation">(</span><span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>GATT_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">BluetoothGattService</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> mac<span class="token punctuation">,</span> <span class="token class-name">UUID</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;BluetoothGatt未初始化&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">onBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> mBinder<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onUnbind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onUnbind</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LocalBinder</span> <span class="token keyword">extends</span> <span class="token class-name">Binder</span> <span class="token punctuation">{</span>
		<span class="token keyword">public</span> <span class="token class-name">BluetoothLeService</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token class-name">BluetoothLeService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 处理Service被发现
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dealServicesDiscoverd</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> mac <span class="token operator">=</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mMediaPlayer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mMediaPlayer<span class="token punctuation">.</span><span class="token function">isPlaying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mMediaPlayer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token function">displayGattServices</span><span class="token punctuation">(</span><span class="token function">getSupportedGattServices</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">,</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 处理设备断开的情况
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dealDeviceDisconnected</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> mac <span class="token operator">=</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// TODO</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;断开连接 响铃:&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		mBluetoothGatts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">QueryBuilder</span> qb <span class="token operator">=</span> <span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDaoSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeagleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token class-name">BeagleDao<span class="token punctuation">.</span>Properties<span class="token punctuation">.</span>Mac</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Beagle</span><span class="token punctuation">&gt;</span></span> mBeagles <span class="token operator">=</span> qb<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Beagle</span> beagle<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mBeagles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			beagle <span class="token operator">=</span> mBeagles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>beagle<span class="token punctuation">.</span><span class="token function">getPhoneAlarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">isNeedNotify</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> beagle<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beagle<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token function">bellToRemind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">Intent</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">GattUpdateReceiver</span><span class="token punctuation">.</span>ACTION_CANCEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">PendingIntent</span> pIntent <span class="token operator">=</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span><span class="token function">getBroadcast</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token class-name">PendingIntent</span><span class="token punctuation">.</span>FLAG_UPDATE_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Uri</span> ringUri <span class="token operator">=</span> <span class="token class-name">RingtoneManager</span><span class="token punctuation">.</span><span class="token function">getDefaultUri</span><span class="token punctuation">(</span><span class="token class-name">RingtoneManager</span><span class="token punctuation">.</span>TYPE_NOTIFICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Notification</span> notify <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotificationCompat
					<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setTicker</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>app_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setContentTitle</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>app_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setContentText</span><span class="token punctuation">(</span><span class="token string">&quot;Device &quot;</span> <span class="token operator">+</span> beagle<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; Disconnected&quot;</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setSmallIcon</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_notification<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setAutoCancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setOngoing</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setContentIntent</span><span class="token punctuation">(</span>pIntent<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">setSound</span><span class="token punctuation">(</span>ringUri<span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">MyApplication</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getmNotificationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">GattUpdateReceiver</span><span class="token punctuation">.</span>NOTIFY_ID<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 通知主界面</span>
		<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_GATT_DISCONNECTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
		e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MediaPlayer</span> mMediaPlayer<span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 处理接收到的数据
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dealWithData</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;进入方法:dealWithData()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">final</span> <span class="token class-name">UUID</span> uuid <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> mac <span class="token operator">=</span> gatt<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataArr <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> dataString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>dataArr<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;接收到地址:&quot;</span> <span class="token operator">+</span> mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;接收到参数:&quot;</span> <span class="token operator">+</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">byteArrayToHexString</span><span class="token punctuation">(</span>dataArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;接收到参数:&quot;</span> <span class="token operator">+</span> dataString<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_KEY_C_PRESS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">int</span> v <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">getIntFromByte</span><span class="token punctuation">(</span>dataArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 短按</span>
				<span class="token comment">// 通知主界面</span>
				<span class="token class-name">StatusEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">StatusEvent</span><span class="token punctuation">.</span>ACTION_PRESS_SHORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
				e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 长按</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mMediaPlayer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mMediaPlayer<span class="token punctuation">.</span><span class="token function">isPlaying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					mMediaPlayer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">bellToRemind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_BATTERY_C_LEVEL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// 通知设备信息界面</span>
			<span class="token class-name">BatteryEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BatteryEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">getIntFromByte</span><span class="token punctuation">(</span>dataArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_DEVICEINFO_C_FIRMWARE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// 通知设备信息界面</span>
			<span class="token class-name">FirmwareEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FirmwareEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>dataString<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">bellToRemind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">AudioManager</span> am <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AudioManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>AUDIO_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> max <span class="token operator">=</span> am<span class="token punctuation">.</span><span class="token function">getStreamMaxVolume</span><span class="token punctuation">(</span><span class="token class-name">AudioManager</span><span class="token punctuation">.</span>STREAM_MUSIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
		am<span class="token punctuation">.</span><span class="token function">setStreamVolume</span><span class="token punctuation">(</span><span class="token class-name">AudioManager</span><span class="token punctuation">.</span>STREAM_MUSIC<span class="token punctuation">,</span> max<span class="token punctuation">,</span> <span class="token class-name">AudioManager</span><span class="token punctuation">.</span>FLAG_PLAY_SOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mMediaPlayer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mMediaPlayer<span class="token punctuation">.</span><span class="token function">isPlaying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			mMediaPlayer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		mMediaPlayer <span class="token operator">=</span> <span class="token class-name">MediaPlayer</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>raw<span class="token punctuation">.</span>helium<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mMediaPlayer<span class="token punctuation">.</span><span class="token function">setAudioStreamType</span><span class="token punctuation">(</span><span class="token class-name">AudioManager</span><span class="token punctuation">.</span>STREAM_MUSIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mMediaPlayer<span class="token punctuation">.</span><span class="token function">setLooping</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//循环播放</span>
		mMediaPlayer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">BluetoothGattCharacteristic</span> mNotifyCharacteristic<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">displayGattServices</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothGattService</span><span class="token punctuation">&gt;</span></span> gattServices<span class="token punctuation">,</span> <span class="token class-name">String</span> mac<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>gattServices <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGattService</span> gattService <span class="token operator">:</span> gattServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BluetoothGattCharacteristic</span><span class="token punctuation">&gt;</span></span> gattCharacteristics <span class="token operator">=</span> gattService<span class="token punctuation">.</span><span class="token function">getCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">String</span> uuid0 <span class="token operator">=</span> gattService<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;服务uuid0=&quot;</span> <span class="token operator">+</span> uuid0<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// Loops through available Characteristics.</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BluetoothGattCharacteristic</span> gattCharacteristic <span class="token operator">:</span> gattCharacteristics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">UUID</span> uuid <span class="token operator">=</span> gattCharacteristic<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;服务uuid=&quot;</span> <span class="token operator">+</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 监听按键指令以及认证结果信息</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_KEY_C_PRESS<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span> <span class="token operator">||</span>
						<span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA_C_LOGIN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;启动监听通知服务uuid=&quot;</span> <span class="token operator">+</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">int</span> charaProp <span class="token operator">=</span> gattCharacteristic<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>charaProp <span class="token operator">|</span> <span class="token class-name">BluetoothGattCharacteristic</span><span class="token punctuation">.</span>PROPERTY_NOTIFY<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						mNotifyCharacteristic <span class="token operator">=</span> gattCharacteristic<span class="token punctuation">;</span>
						<span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span>mac<span class="token punctuation">,</span> gattCharacteristic<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 建立连接后，搜寻到设备服务，且该设备并未找到绑定记录，则写入认证信息进行绑定</span>
		<span class="token class-name">String</span> imei <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TelephonyManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>TELEPHONY_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> loginValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 认证的具体内容我就不写了，这个是要与设备固件开发约定好的</span>

		<span class="token keyword">boolean</span> loginFlag <span class="token operator">=</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span><span class="token function">sendValueToBle</span><span class="token punctuation">(</span>mac<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span><span class="token punctuation">.</span>UUID_S_EXTRA<span class="token punctuation">,</span> <span class="token class-name">BluetoothUtils</span>
				<span class="token punctuation">.</span>UUID_S_EXTRA_C_LOGIN<span class="token punctuation">,</span> loginValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">BuglyLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;写入认证信息=&quot;</span> <span class="token operator">+</span> loginFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loginFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">BindEvent</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">BindEvent</span><span class="token punctuation">.</span>ACTION_BIND_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
			e<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">EventBus</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/android/ble-tether-1.html" class="prev">
        【BLE】蓝牙「防丢器」（一）
      </a></span> <span class="next"><a href="/android/ble-tether-3.html">
        【BLE】蓝牙「防丢器」（三）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.67f31782.js" defer></script><script src="/assets/js/2.4b79b7dc.js" defer></script><script src="/assets/js/14.74441acb.js" defer></script>
  </body>
</html>
